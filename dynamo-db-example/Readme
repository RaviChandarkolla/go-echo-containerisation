# Terminal 1: DynamoDB Local
docker run -d -p 8000:8000 --name dynamodb amazon/dynamodb-local

# Terminal 2: Build & Run
docker build -t dynamodb-go-app .
docker run -d -p 8080:8080 -e DYNAMODB_TABLE="local-table" -e AWS_ENDPOINT_URL="http://host.docker.internal:8000" --add-host=host.docker.internal:host-gateway dynamodb-go-app

# Test
curl -X POST http://localhost:8080/items -H "Content-Type: application/json" -d '{"id":"user1","score":100}'

curl http://localhost:8080/items/user1

# Deploy
minikube start
docker build -t dynamodb-go-app:latest .
docker tag dynamodb-go-app:latest localhost:5000/dynamodb-go-app:latest
minikube image load localhost:5000/dynamodb-go-app:latest
kubectl apply -f dynamodb-deployment.yaml
kubectl port-forward svc/dynamodb-service 8080:80
curl -X POST http://localhost:8080/items -d '{"id":"k8s-test","score":42}'


# AWS CLI after executing into the dynamo-cli container

docker exec -it <container-id> /bin/sh

# 1. List ALL tables (your Go app created local-table)
aws dynamodb list-tables --endpoint-url http://dynamodb:8000

# 2. Describe table structure
aws dynamodb describe-table --table-name local-table --endpoint-url http://dynamodb:8000

# 3. Scan ALL data (shows your Go app PUT requests)
aws dynamodb scan --table-name local-table --endpoint-url http://dynamodb:8000

# 4. Create NEW table (if needed)
aws dynamodb create-table \
  --table-name test-table \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --endpoint-url http://dynamodb:8000

# =============================================#
# Local Secondary Index example
#examples. these needs to be run inside the dynamodb-cli container
aws dynamodb create-table \
  --table-name users \
  --key-schema AttributeName=id,KeyType=HASH AttributeName=timestamp,KeyType=RANGE \
  --attribute-definitions \
    AttributeName=id,AttributeType=S \
    AttributeName=timestamp,AttributeType=N \
    AttributeName=score,AttributeType=N \
  --billing-mode PAY_PER_REQUEST \
  --local-secondary-indexes '[
    {
      "IndexName": "ScoreIndex",
      "KeySchema": [
        {"AttributeName": "id", "KeyType": "HASH"},
        {"AttributeName": "score", "KeyType": "RANGE"}
      ],
      "Projection": {
        "ProjectionType": "KEYS_ONLY"
      }
    }
  ]' \
  --endpoint-url http://dynamodb:8000

# Insert sample data
aws dynamodb put-item \
  --table-name users \
  --item '{
    "id": {"S": "user1"},
    "timestamp": {"N": "1699123200"},
    "score": {"N": "250"}
  }' \
  --endpoint-url http://dynamodb:8000

# fetch sample data
aws dynamodb get-item \
  --table-name users \
  --key '{
    "id": {"S": "user1"},
    "timestamp": {"N": "1699123200"}
  }' \
  --endpoint-url http://dynamodb:8000


# Query by score within user partition
aws dynamodb query \
  --table-name users \
  --index-name ScoreIndex \
  --key-condition "id = 'user1' AND score BETWEEN :low AND :high" \
  --endpoint-url http://dynamodb:8000

# =============================================#

